<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Non-parametric back-projection of incidence cases to exposure cases
  using a known incubation time as in Becker et al (1991) — backprojNP • surveillance</title>
<script src="../deps/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="../deps/bs3compat-0.2.4/tabs.js"></script><script src="../deps/bs3compat-0.2.4/bs3compat.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css">
<script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<link href="../syntax-highlighting.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Non-parametric back-projection of incidence cases to exposure cases
  using a known incubation time as in Becker et al (1991) — backprojNP">
<meta property="og:description" content="The function is an implementation of the non-parametric
  back-projection of incidence cases to exposure cases described in
  Becker et al. (1991). The method back-projects exposure times
  from a univariate time series containing the number of symptom onsets per time
  unit. Here, the delay between exposure and symptom onset for an
  individual is seen as a realization of a random variable governed by a
  known probability mass function.
  The back-projection function calculates the expected number of exposures
  \(\lambda_t\) for each time unit under the assumption of a
  Poisson distribution, but without any parametric assumption on how the
  \(\lambda_t\) evolve in time.
Furthermore, the function contains a bootstrap based procedure, as
  given in Yip et al (2011), which allows an indication of uncertainty
  in the estimated \(\lambda_t\). The procedure is
  equivalent to the suggestion in Becker and Marschner (1993). However,
  the present implementation in backprojNP allows only a
  univariate time series, i.e. simultaneous age groups as in Becker and
  Marschner (1993) are not possible.
The method in Becker et al. (1991) was originally developed for the
  back-projection of AIDS incidence, but it is equally useful for
  analysing the epidemic curve in outbreak situations of a disease
  with long incubation time, e.g. in order to qualitatively investigate
  the effect of intervention measures.">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@bastistician">
<meta name="twitter:site" content="@bastistician">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc" data-headroom>
    

      <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a class="navbar-brand mb-0 h1" href="../index.html">surveillance</a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <button type="button" id="version-badge" class="badge badge-default d-none d-lg-block" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Released version">1.19.1</button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto ml-3">
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/overview.html">Overview</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/events.html">Events</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/bibliography.html">Bibliography</a>
</li>
      </ul>
<ul class="navbar-nav ml-1"></ul>
</div>
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <div class="col-md-9 contents">
    <img src="" class="pkg-logo" alt=""><div class="page-header pb-2 mt-4 mb-2 border-bottom toc-ignore">
    <h1 class="display-4">Non-parametric back-projection of incidence cases to exposure cases
  using a known incubation time as in Becker et al (1991)</h1>
    
    <div class="d-none name"><code>backprojNP.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>The function is an implementation of the non-parametric
  back-projection of incidence cases to exposure cases described in
  Becker et al. (1991). The method back-projects exposure times
  from a univariate time series containing the number of symptom onsets per time
  unit. Here, the delay between exposure and symptom onset for an
  individual is seen as a realization of a random variable governed by a
  known probability mass function.
  The back-projection function calculates the expected number of exposures
  \(\lambda_t\) for each time unit under the assumption of a
  Poisson distribution, but without any parametric assumption on how the
  \(\lambda_t\) evolve in time.</p>
<p>Furthermore, the function contains a bootstrap based procedure, as
  given in Yip et al (2011), which allows an indication of uncertainty
  in the estimated \(\lambda_t\). The procedure is
  equivalent to the suggestion in Becker and Marschner (1993). However,
  the present implementation in <code>backprojNP</code> allows only a
  univariate time series, i.e. simultaneous age groups as in Becker and
  Marschner (1993) are not possible.</p>
<p>The method in Becker et al. (1991) was originally developed for the
  back-projection of AIDS incidence, but it is equally useful for
  analysing the epidemic curve in outbreak situations of a disease
  with long incubation time, e.g. in order to qualitatively investigate
  the effect of intervention measures.</p>
    </div>

    <pre class="usage"><code class="sourceCode R"><span class="fu">backprojNP</span><span class="op">(</span><span class="va">sts</span>, <span class="va">incu.pmf</span>, 
   control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">2</span>, 
                  eps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.005</span>,<span class="fl">2</span><span class="op">)</span>, 
                  iter.max<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">250</span>,<span class="fl">2</span><span class="op">)</span>, 
                  Tmark <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sts</span><span class="op">)</span>, 
                  B <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, 
                  alpha <span class="op">=</span> <span class="fl">0.05</span>, 
                  verbose <span class="op">=</span> <span class="cn">FALSE</span>, 
                  lambda0 <span class="op">=</span> <span class="cn">NULL</span>,
                  eq3a.method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"R"</span>,<span class="st">"C"</span><span class="op">)</span>,
                  hookFun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">stsbp</span><span class="op">)</span> <span class="op">{</span><span class="op">}</span><span class="op">)</span>,
     <span class="va">...</span><span class="op">)</span></code></pre>

    <h2>Arguments</h2>
    <dl class="row" id="ref-arguments">
<dt class="col-sm-3" id="ref-arguments name">sts</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>an object of class <code>"<a href="sts-class.html">sts</a>"</code> (or one that can be
    coerced to that class): contains the observed number of symptom
    onsets as a time series.</p></dd>
    <dt class="col-sm-3" id="ref-arguments name">incu.pmf</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>Probability mass function (PMF) of the incubation
    time. The PMF is specified as a vector or matrix with the value of
    the PMF evaluated at \(0,...,d_max\), i.e. note that the
    support includes zero. The value of \(d_max\) is
    automatically calculated as <code>length(incu.pmf)-1</code> or
    <code>nrow(incu.pmf)-1</code>. Note that if the sts object has more
    than one column, then for the backprojection the incubation time is
    either recycled for all components or, if it is a matrix with
    the same number of columns as the sts object, the \(k\)'th
    column of <code>incu.pmf</code> is used for the backprojection of the
    \(k\)'th series.</p></dd>
    <dt class="col-sm-3" id="ref-arguments name">control</dt>
      <dd class="col-sm-9" id="ref-arguments desc">
<p>A list with named arguments controlling the
    functionality of the non-parametric back-projection.</p>
<dl>
<dt><code>k</code></dt>
<dd><p>An integer representing the smoothing parameter to use in the smoothing step
	of the EMS algorithm. Needs to be an even number.</p></dd>
      <dt><code>eps</code></dt>
<dd><p>A vector of length two representing the
	convergence threshold \(\epsilon\) of the EMS algorithm, see Details for further
	information. The first value is the threshold to use in the
	\(k=0\) loop, which forms the values for the parametric
	bootstrap. The second value is the threshold to use in the actual fit
	and bootstrap fitting using the specified <code>k</code>. If <code>k</code> is
	only of length one, then this number is replicated twice.</p></dd>
      <dt><code>Tmark</code></dt>
<dd><p>Numeric with \(T'\leq T\). Upper time limit
  on which to base convergence, i.e. only the values
  \(\lambda_1,\ldots,\lambda_{T'}\) are monitored for convergence. See
  details.</p></dd>
      <dt><code>iter.max</code></dt>
<dd><p>The maximum number of EM iterations to do before stopping.</p></dd>
      <dt><code>B</code></dt>
<dd><p>Number of parametric bootstrap samples to perform from an
	initial k=0 fit. For each sample a back projection is performed.
	See Becker and Marschner (1993) for details.</p></dd>
      <dt><code>alpha</code></dt>
<dd><p>(1-\(\alpha\))*100% confidence
  intervals are computed based on the percentile method.</p></dd>
      <dt><code>verbose</code></dt>
<dd><p>(boolean). If true show extra progress and
      debug information.</p></dd>
      <dt><code>lambda0</code></dt>
<dd><p>Start values for lambda. Vector needs to be
	of the length <code><a href="https://rdrr.io/r/base/nrow.html">nrow(sts)</a></code>.</p></dd>
      <dt><code>eq3a.method</code></dt>
<dd><p>A single character being either
	<code>"R"</code> or <code>"C"</code> depending on whether the three nested loops
	of equation 3a in Becker et al. (1991) are to be executed as safe R
	code (can be extremely slow, however the implementation is not
	optimized for speed) or a C code (can be more than 200 times
	faster!). However, the C implementation is experimental and can
	hang R if, e.g., the time series does not go far enough back.</p></dd>
      <dt><code>hookFun</code></dt>
<dd><p>Hook function called for each iteration of the EM algorithm. The
	function should take a single argument <code>stsbp</code> of class
	<code>"<a href="stsBP-class.html">stsBP</a>"</code> class. It will be have the
        lambda set to the current value of lambda. If no action desired
        just leave the function body empty (default). Additional
	arguments are possible.</p></dd>
    
</dl>
<p></p>
</dd>
    <dt class="col-sm-3" id="ref-arguments name">...</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>Additional arguments are sent to the hook function.</p></dd>
    </dl>
<h2 class="hasAnchor" id="details">
<a class="anchor" href="#details"></a>Details</h2>

    <p>Becker et al. (1991) specify a non-parametric back-projection
  algorithm based on the Expectation-Maximization-Smoothing (EMS)
  algorithm.</p>  
<p>In the present implementation the algorithm iterates until
  $$\frac{||\lambda^{(k+1)} - \lambda^{(k)}||}{||\lambda^{(k)}||} &lt;
  \epsilon$$ This is a slight adaptation of the proposals in Becker et
  al. (1991). If \(T\) is the length of \(\lambda\) then one can
  avoid instability of the algorithm near the end by considering only
  the \(\lambda\)'s with index \(1,\ldots,T'\).</p>
  
<p>See the references for further information.</p>
    <h2 class="hasAnchor" id="value">
<a class="anchor" href="#value"></a>Value</h2>

    <p><code>backprojNP</code> returns an object of <code>"<a href="stsBP-class.html">stsBP</a>"</code>.</p>
    <h2 class="hasAnchor" id="references">
<a class="anchor" href="#references"></a>References</h2>

    <p>Becker NG, Watson LF and Carlin JB (1991), A method for
  non-parametric back-projection and its application to AIDS data,
  Statistics in Medicine, 10:1527-1542.</p>  
<p>Becker NG and Marschner IC (1993), A method for estimating the
  age-specific relative risk of HIV infection from AIDS incidence data,
  Biometrika, 80(1):165-178.</p>
<p>Yip PSF, Lam KF, Xu Y, Chau PH, Xu J, Chang W, Peng Y, Liu Z, Xie X and
  Lau HY (2011), Reconstruction of the Infection Curve for SARS Epidemic
  in Beijing, China Using a Back-Projection Method, Communications in
  Statistics - Simulation and Computation, 37(2):425-433.</p>
<p>Associations of Age and Sex on Clinical Outcome and Incubation Period
  of Shiga toxin-producing Escherichia coli O104:H4 Infections, 2011
  (2013), Werber D, King LA, Müller L, Follin P, Buchholz U, Bernard H,
  Rosner BM, Ethelberg S, de Valk H, Höhle M, American Journal of
  Epidemiology, 178(6):984-992.</p>
    <h2 class="hasAnchor" id="author">
<a class="anchor" href="#author"></a>Author</h2>

    <p>Michael Höhle with help by
  Daniel Sabanés Bové for the <span class="pkg">Rcpp</span> interface</p>
    <h2 class="hasAnchor" id="note">
<a class="anchor" href="#note"></a>Note</h2>

    <p>The method is still experimental. A proper plot routine for
  <code>stsBP</code> objects is currently missing.</p>

    <h2 class="hasAnchor" id="examples">
<a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><code class="sourceCode R"><span class="co">#Generate an artificial outbreak of size n starting at time t0 and being of length</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e3</span> ; <span class="va">t0</span> <span class="op">&lt;-</span> <span class="fl">23</span> ; <span class="va">l</span> <span class="op">&lt;-</span> <span class="fl">10</span>

<span class="co">#PMF of the incubation time is an interval censored gamma distribution</span>
<span class="co">#with mean 15 truncated at 25.</span>
<span class="va">dmax</span> <span class="op">&lt;-</span> <span class="fl">25</span>
<span class="va">inc.pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">pgamma</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">dmax</span>,<span class="fl">15</span>,<span class="fl">1.4</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">pgamma</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">dmax</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,<span class="fl">15</span>,<span class="fl">1.4</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">pgamma</a></span><span class="op">(</span><span class="va">dmax</span>,<span class="fl">15</span>,<span class="fl">1.4</span><span class="op">)</span><span class="op">)</span>
<span class="co">#Function to sample from the incubation time</span>
<span class="va">rincu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">dmax</span>, size<span class="op">=</span><span class="va">n</span>, replace<span class="op">=</span><span class="cn">TRUE</span>, prob<span class="op">=</span><span class="va">inc.pmf</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#Sample time of exposure and length of incubation time</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">exposureTimes</span> <span class="op">&lt;-</span> <span class="va">t0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">l</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>,size<span class="op">=</span><span class="va">n</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">symptomTimes</span> <span class="op">&lt;-</span> <span class="va">exposureTimes</span> <span class="op">+</span> <span class="fu">rincu</span><span class="op">(</span><span class="va">n</span><span class="op">)</span>

<span class="co">#Time series of exposure (truth) and symptom onset (observed)</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">exposureTimes</span>,levels<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">symptomTimes</span><span class="op">)</span><span class="op">+</span><span class="va">dmax</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">symptomTimes</span>,levels<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">symptomTimes</span><span class="op">)</span><span class="op">+</span><span class="va">dmax</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#Convert Y to an sts object</span>
<span class="va">Ysts</span> <span class="op">&lt;-</span> <span class="fu"><a href="sts-class.html">sts</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>

<span class="co">#Plot the outbreak</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Ysts</span>, xaxis.labelFormat<span class="op">=</span><span class="cn">NULL</span>, legend<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>
<span class="co">#Add true number of exposures to the plot</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">+</span><span class="fl">0.2</span>,<span class="va">X</span>,col<span class="op">=</span><span class="st">"red"</span>,type<span class="op">=</span><span class="st">"h"</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>


<span class="co">#Helper function to show the EM step</span>
<span class="va">plotIt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cur.sts</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cur.sts</span>,xaxis.labelFormat<span class="op">=</span><span class="cn">NULL</span>, legend<span class="op">=</span><span class="cn">NULL</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">140</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#Call non-parametric back-projection function with hook function but</span>
<span class="co">#without bootstrapped confidence intervals</span>
<span class="va">bpnp.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>k<span class="op">=</span><span class="fl">0</span>,eps<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.005</span>,<span class="fl">2</span><span class="op">)</span>,iter.max<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">250</span>,<span class="fl">2</span><span class="op">)</span>,B<span class="op">=</span><span class="op">-</span><span class="fl">1</span>,hookFun<span class="op">=</span><span class="va">plotIt</span>,verbose<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="co">#Fast C version (use argument: eq3a.method="C")! </span>
<span class="va">sts.bp</span> <span class="op">&lt;-</span> <span class="fu">backprojNP</span><span class="op">(</span><span class="va">Ysts</span>, incu.pmf<span class="op">=</span><span class="va">inc.pmf</span>,
    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html">modifyList</a></span><span class="op">(</span><span class="va">bpnp.control</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>eq3a.method<span class="op">=</span><span class="st">"C"</span><span class="op">)</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">X</span>,<span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">#Show result</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sts.bp</span>,xaxis.labelFormat<span class="op">=</span><span class="cn">NULL</span>,legend<span class="op">=</span><span class="cn">NULL</span>,lwd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,lty<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,main<span class="op">=</span><span class="st">""</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">+</span><span class="fl">0.2</span>,<span class="va">X</span>,col<span class="op">=</span><span class="st">"red"</span>,type<span class="op">=</span><span class="st">"h"</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>

<span class="co">#Do the convolution for the expectation</span>
<span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,ncol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sts.bp</span><span class="op">)</span>,nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sts.bp</span><span class="op">)</span><span class="op">)</span>
<span class="co">#Loop over all series</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sts.bp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> 
  <span class="co">#Loop over all time points</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sts.bp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="co">#Convolution, note support of inc.pmf starts at zero (move idx by 1)</span>
    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span>
    <span class="va">mu</span><span class="op">[</span><span class="va">t</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">inc.pmf</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="stsSlots.html">upperbound</a></span><span class="op">(</span><span class="va">sts.bp</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="co">#Show the fit</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sts.bp</span><span class="op">)</span><span class="op">-</span><span class="fl">0.5</span>,<span class="va">mu</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,col<span class="op">=</span><span class="st">"green"</span>,type<span class="op">=</span><span class="st">"s"</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span>

<span class="co">#Non-parametric back-projection including boostrap CIs. B=10 is only</span>
<span class="co">#used for illustration in the documentation example</span>
<span class="co">#In practice use a realistic value of B=1000 or more.</span>
<span class="va">bpnp.control2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html">modifyList</a></span><span class="op">(</span><span class="va">bpnp.control</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>hookFun<span class="op">=</span><span class="cn">NULL</span>,k<span class="op">=</span><span class="fl">2</span>,B<span class="op">=</span><span class="fl">10</span>,eq3a.method<span class="op">=</span><span class="st">"C"</span><span class="op">)</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
<span class="va">bpnp.control2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html">modifyList</a></span><span class="op">(</span><span class="va">bpnp.control</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>hookFun<span class="op">=</span><span class="cn">NULL</span>,k<span class="op">=</span><span class="fl">2</span>,B<span class="op">=</span><span class="fl">1000</span>,eq3a.method<span class="op">=</span><span class="st">"C"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">sts.bp2</span> <span class="op">&lt;-</span> <span class="fu">backprojNP</span><span class="op">(</span><span class="va">Ysts</span>, incu.pmf<span class="op">=</span><span class="va">inc.pmf</span>, control<span class="op">=</span><span class="va">bpnp.control2</span><span class="op">)</span>

<span class="co">######################################################################</span>
<span class="co"># Plot the result. This is currently a manual routine.</span>
<span class="co"># ToDo: Need to specify a plot method for stsBP objects which also</span>
<span class="co">#       shows the CI.</span>
<span class="co">#</span>
<span class="co"># Parameters:</span>
<span class="co">#  stsBP - object of class stsBP which is to be plotted.</span>
<span class="co">######################################################################</span>

<span class="va">plot.stsBP</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">stsBP</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">maxy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="stsSlots.html">observed</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">)</span>,<span class="fu"><a href="stsSlots.html">upperbound</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">)</span>,<span class="va">stsBP</span><span class="op">@</span><span class="va">ci</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="stsSlots.html">upperbound</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"n"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">maxy</span><span class="op">)</span>, ylab<span class="op">=</span><span class="st">"Cases"</span>,xlab<span class="op">=</span><span class="st">"time"</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">@</span><span class="va">ci</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/polygon.html">polygon</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
             <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">@</span><span class="va">ci</span><span class="op">[</span><span class="fl">2</span>,,<span class="fl">1</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">@</span><span class="va">ci</span><span class="op">[</span><span class="fl">1</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"lightgray"</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="stsSlots.html">upperbound</a></span><span class="op">(</span><span class="va">stsBP</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"l"</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"topright"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,lty<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,border<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,lwd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#Plot the result of k=0 and add truth for comparison. No CIs available</span>
<span class="fu">plot.stsBP</span><span class="op">(</span><span class="va">sts.bp</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>,<span class="va">X</span>,col<span class="op">=</span><span class="fl">2</span>,type<span class="op">=</span><span class="st">"h"</span><span class="op">)</span>
<span class="co">#Same for k=2</span>
<span class="fu">plot.stsBP</span><span class="op">(</span><span class="va">sts.bp2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>,<span class="va">X</span>,col<span class="op">=</span><span class="fl">2</span>,type<span class="op">=</span><span class="st">"h"</span><span class="op">)</span>

</code></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="sticky-top">
    <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>

    </nav>
</div>
  </div>
</div>


      <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Maintained by <a href="http://www.imbe.med.uni-erlangen.de/cms/sebastian_meyer.html" class="external-link">Sebastian Meyer</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001. Hosted on <a href="https://R-forge.R-project.org/projects/surveillance/" class="external-link"><img src="https://r-forge.r-project.org/themes/rforge/imagesrf/logo.png" height="18" alt="R-Forge"></a></p>
</div>

      </footer>
</div>

  


  

  </body>
</html>

