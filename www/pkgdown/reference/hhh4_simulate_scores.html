<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Proper Scoring Rules for Simulations from hhh4 Models — hhh4_simulate_scores • surveillance</title>
<script src="../deps/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="../deps/bs3compat-0.2.4/tabs.js"></script><script src="../deps/bs3compat-0.2.4/bs3compat.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css">
<script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<link href="../syntax-highlighting.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Proper Scoring Rules for Simulations from hhh4 Models — hhh4_simulate_scores">
<meta property="og:description" content="Calculate proper scoring rules based on simulated predictive distributions.">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@bastistician">
<meta name="twitter:site" content="@bastistician">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc" data-headroom>
    

      <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a class="navbar-brand mb-0 h1" href="../index.html">surveillance</a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <button type="button" id="version-badge" class="badge badge-default d-none d-lg-block" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Released version">1.19.1</button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto ml-3">
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/overview.html">Overview</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/events.html">Events</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/pkgdown/bibliography.html">Bibliography</a>
</li>
      </ul>
<ul class="navbar-nav ml-1"></ul>
</div>
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <div class="col-md-9 contents">
    <img src="" class="pkg-logo" alt=""><div class="page-header pb-2 mt-4 mb-2 border-bottom toc-ignore">
    <h1 class="display-4">Proper Scoring Rules for Simulations from <code>hhh4</code> Models</h1>
    
    <div class="d-none name"><code>hhh4_simulate_scores.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Calculate proper scoring rules based on simulated predictive distributions.</p>
    </div>

    <pre class="usage"><code class="sourceCode R"><span class="co"># S3 method for hhh4sims</span>
<span class="fu"><a href="scores.html">scores</a></span><span class="op">(</span><span class="va">x</span>, which <span class="op">=</span> <span class="st">"rps"</span>, units <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># S3 method for hhh4simslist</span>
<span class="fu"><a href="scores.html">scores</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></code></pre>

    <h2>Arguments</h2>
    <dl class="row" id="ref-arguments">
<dt class="col-sm-3" id="ref-arguments name">x</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>an object of class <code>"hhh4sims"</code> (as resulting from the
    <code><a href="hhh4_simulate.html">simulate</a></code>-method for
    <code>"<a href="hhh4.html">hhh4</a>"</code> models if <code>simplify = TRUE</code> was set),
    or an <code>"hhh4simslist"</code>, i.e.,
    a list of such simulations potentially obtained from different
    model fits (using the same simulation period).</p></dd>
    <dt class="col-sm-3" id="ref-arguments name">which</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>a character vector indicating which proper scoring rules to compute.
    By default, only the ranked probability score (<code>"rps"</code>) is
    calculated. Other options include <code>"logs"</code> and <code>"dss"</code>.</p></dd>
    <dt class="col-sm-3" id="ref-arguments name">units</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>if non-<code>NULL</code>, an integer or character vector indexing the
    columns of <code>x</code> for which to compute the scores.</p></dd>
    <dt class="col-sm-3" id="ref-arguments name">drop</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>a logical indicating if univariate dimensions should be dropped
    (the default).</p></dd>
    <dt class="col-sm-3" id="ref-arguments name">...</dt>
      <dd class="col-sm-9" id="ref-arguments desc"><p>unused (argument of the generic).</p></dd>
    </dl>
<h2 class="hasAnchor" id="details">
<a class="anchor" href="#details"></a>Details</h2>

    <p>This implementation can only compute <em>univariate scores</em>, i.e.,
  independently for each time point.</p>  
<p>The logarithmic score is badly estimated if the domain is large and
  there are not enough samples to cover the underlying distribution in
  enough detail (the score becomes infinite when an observed value does
  not occur in the samples). An alternative is to use kernel density
  estimation as implemented in the <span style="R">R</span> package <a href="https://CRAN.R-project.org/package=scoringRules"><span class="pkg">scoringRules</span></a>.</p>
    <h2 class="hasAnchor" id="author">
<a class="anchor" href="#author"></a>Author</h2>

    <p>Sebastian Meyer</p>

    <h2 class="hasAnchor" id="examples">
<a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"salmAllOnset"</span><span class="op">)</span>

<span class="co">## fit a hhh4 model to the first 13 years</span>
<span class="va">salmModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="fu"><a href="addSeason2formula.html">addSeason2formula</a></span><span class="op">(</span><span class="op">~</span><span class="fl">1</span> <span class="op">+</span> <span class="va">t</span><span class="op">)</span><span class="op">)</span>,
                  ar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>f <span class="op">=</span> <span class="op">~</span><span class="fl">1</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"NegBin1"</span>, subset <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">678</span><span class="op">)</span>
<span class="va">salmFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="hhh4.html">hhh4</a></span><span class="op">(</span><span class="va">salmAllOnset</span>, <span class="va">salmModel</span><span class="op">)</span>

<span class="co">## simulate the next 20 weeks ahead (with very small 'nsim' for speed)</span>
<span class="va">salmSims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/simulate.html">simulate</a></span><span class="op">(</span><span class="va">salmFit</span>, nsim <span class="op">=</span> <span class="fl">500</span>, seed <span class="op">=</span> <span class="fl">3</span>, subset <span class="op">=</span> <span class="fl">678</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>,
                     y.start <span class="op">=</span> <span class="fu"><a href="stsSlots.html">observed</a></span><span class="op">(</span><span class="va">salmAllOnset</span><span class="op">)</span><span class="op">[</span><span class="fl">678</span>,<span class="op">]</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"fanplot"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="st">"fan"</span><span class="op">)</span>


<span class="co">### calculate scores at each time point</span>

<span class="co">## using empirical distribution of simulated counts as forecast distribution</span>
<span class="fu"><a href="scores.html">scores</a></span><span class="op">(</span><span class="va">salmSims</span>, which <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rps"</span>, <span class="st">"logs"</span>, <span class="st">"dss"</span><span class="op">)</span><span class="op">)</span>
<span class="co">## observed count sometimes not covered by simulations -&gt; infinite log-score</span>
<span class="co">## =&gt; for a more detailed forecast, either considerably increase 'nsim', or:</span>

<span class="co">## 1. use continuous density() of simulated counts as forecast distribution</span>
<span class="va">fi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="fl">1</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html">approxfun</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">logs_kde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="kw">function</span> <span class="op">(</span><span class="va">f</span>, <span class="va">y</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>,
                   f <span class="op">=</span> <span class="va">fi</span>, y <span class="op">=</span> <span class="fu"><a href="stsSlots.html">observed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">salmSims</span>,<span class="st">"stsObserved"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="st">"empirical"</span> <span class="op">=</span> <span class="fu"><a href="scores.html">scores</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="st">"logs"</span><span class="op">)</span>, <span class="st">"density"</span> <span class="op">=</span> <span class="va">logs_kde</span><span class="op">)</span>
<span class="co">## a similar KDE approach is implemented in scoringRules::logs_sample()</span>

<span class="co">## 2. average conditional predictive NegBin's of simulated trajectories,</span>
<span class="co">##    currently only implemented in HIDDA.forecasting::dhhh4sims()</span>


<span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
<span class="co">### produce a PIT histogram</span>

<span class="co">## using empirical distribution of simulated counts as forecast distribition</span>
<span class="fu"><a href="pit.html">pit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="stsSlots.html">observed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="st">"stsObserved"</span><span class="op">)</span><span class="op">)</span>,
    pdistr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">salmSims</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">ecdf</span><span class="op">)</span><span class="op">)</span>
<span class="co">## long-term forecast is badly calibrated (lower tail is unused, see fan above)</span>
<span class="co">## we also get a warning for the same reason as infinite log-scores</span>
<span class="op">}</span>
</code></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="sticky-top">
    <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>

    </nav>
</div>
  </div>
</div>


      <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Maintained by <a href="http://www.imbe.med.uni-erlangen.de/cms/sebastian_meyer.html" class="external-link">Sebastian Meyer</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001. Hosted on <a href="https://R-forge.R-project.org/projects/surveillance/" class="external-link"><img src="https://r-forge.r-project.org/themes/rforge/imagesrf/logo.png" height="18" alt="R-Forge"></a></p>
</div>

      </footer>
</div>

  


  

  </body>
</html>

